<!DOCTYPE html>
<html lang="en-US" />
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Forecasting Profits Direction in a Dataset of CAC40 Trades &middot; Tech Vagabond! - Gabriele LUCULLI&#39;s Web Page</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://techvagabond.org/favicon.ico" />
    <link rel="canonical" href="https://techvagabond.org/forecasting-profits-direction-in-a-dataset-of-cac40-trades/" />

     <meta name="description" content="Our dataset consists of many possible trades generated by several different strategies and our main purpose is to identify the most useful features in order to " /> 

     
    
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://techvagabond.org/img/capital-markets-1024x576.jpeg"/>
    
 
    <meta name="twitter:title" content="Forecasting Profits Direction in a Dataset of CAC40 Trades"/>
    <meta name="twitter:description" content="Our dataset consists of many possible trades generated by several different strategies and our main purpose is to identify the most useful features in order to "/>
    <meta name="twitter:url" content="https://techvagabond.org/forecasting-profits-direction-in-a-dataset-of-cac40-trades/" />
    <meta name="twitter:site" content="@"/>

    <meta property="og:site_name" content="Tech Vagabond! - Gabriele LUCULLI&#39;s Web Page" />
    <meta property="og:title" content="Forecasting Profits Direction in a Dataset of CAC40 Trades &middot; Gabriele LUCULLI&#39;s Web Page" />
    <meta property="og:url" content="https://techvagabond.org/forecasting-profits-direction-in-a-dataset-of-cac40-trades/" />
    

    <meta property="og:type" content="article" />
    <meta property="og:description" content="Our dataset consists of many possible trades generated by several different strategies and our main purpose is to identify the most useful features in order to " />

    <meta property="article:published_time" content="0001-01-01T00:00:00Z" />
    <meta property="article:tag" content="Technology" /><meta property="article:tag" content="Machine learning" /><meta property="article:tag" content="Finance" />

    <meta property="og:image" content="https://techvagabond.org/img/capital-markets-1024x576.jpeg"/>


    <meta name="generator" content="Hugo 0.75.1" />

    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="https://techvagabond.org/built/screen.css" /> 
    <link rel="stylesheet" type="text/css" href="https://techvagabond.org/css/casper-two.css" /> 
    <link rel="stylesheet" type="text/css" href="https://techvagabond.org/css/overrides.css" /> 
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" />
     <link rel="stylesheet" href="https://techvagabond.org/css/overrides.css" /> 

     

    
    
    <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
    <link rel="manifest" href="img/favicon/site.webmanifest">
    <link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="img/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
</head>


<body class="ctsingle">

  <div class="site-wrapper"> 

<header class="site-header outer "  style="background-image: url(https://techvagabond.org/img/mountains-sun.jpeg)"  >
  <div class="inner">
    <div class="site-header-content">
      <h1 class="site-title"> Gabriele LUCULLI&#39;s Web Page  </h1>
        <h2 class="site-description">Technology | Finance | Research | Engineering </h2>
    </div>

    <nav class="site-nav">
      <div class="site-nav-left"><ul class="nav" role="menu">
        
        
        
            <li class="" role="menuitem">
              <a href="/">Home</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/categories/papers/">Papers</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/categories/projects/">Projects</a>
            </li>
        
            <li class="" role="menuitem">
              <a href="/categories/blog/">Blog</a>
            </li>
        
      </ul></div>

      <div class="site-nav-right">
        <div class="social-links">
                    

                    

                    <a class="social-link" href="https://github.com/luculli" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>

                    

                    
        </div>  
            
      </div>

    </nav>  

  </div>
</header>


<main id="site-main" class="site-main outer" role="main">
  <div class="inner">
    
    <div class="post-feed">
      <article class="post-card post"> 
    
    <a class="post-card-image-link" href="https://techvagabond.org/forecasting-profits-direction-in-a-dataset-of-cac40-trades/">
      <div class="post-card-image" style="background-image: url(https://techvagabond.org/img/capital-markets-1024x576.jpeg)"></div>
    </a>
    

    <div class="post-card-content">
      <a class="post-card-content-link" href="https://techvagabond.org/forecasting-profits-direction-in-a-dataset-of-cac40-trades/">
          <header class="post-card-header">
              <span class="post-card-tags">
              #Technology 
              #Machine learning 
              #Finance  </span>
              
              <h2 class="post-card-title">Forecasting Profits Direction in a Dataset of CAC40 Trades</h2>
          </header>
      </a>
      <section class="post-card-excerpt" style="padding: 0 25px;">
          <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
    crossorigin="anonymous">
<div class="text-abstract">   
<p>Our dataset consists of many possible trades generated by several different strategies and our main purpose is to identify the most useful features in order to detect the trades with positive gain and therefore the winning strategies. <br></p>
<p>After having imported the data, we are going to clean in it up and to reformat them. Each record of the dataframe is a single transaction which consists of three trades. One trade to open the position and two trades to close it. A transaction can only be closed by taking a profit or by hitting a stop loss. For the moment we don&rsquo;t need to consider the full dataset, we assume that the trades of the past 6 months are sufficient to have an accurate forecasting of the actual day.</p>
<div class="text-code-r"> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"> <span style="color:#75715e"># import data</span>
 dd <span style="color:#f92672">=</span> <span style="color:#a6e22e">read.table</span>(<span style="color:#e6db74">&#34;mytable.txt&#34;</span>, header<span style="color:#f92672">=</span>T);
 dd<span style="color:#f92672">$</span>dstart<span style="color:#f92672">=</span><span style="color:#a6e22e">as.Date</span>(dd<span style="color:#f92672">$</span>dstart);

 <span style="color:#75715e"># get the trades of the past 6 months</span>
 tf<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>; woy_test <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.Date</span>(<span style="color:#e6db74">&#34;2020-09-18&#34;</span>);

 data <span style="color:#f92672">=</span> <span style="color:#a6e22e">subset</span>(dd, (dstart <span style="color:#f92672">&gt;=</span> (woy_test<span style="color:#ae81ff">-7</span>)<span style="color:#f92672">-</span><span style="color:#a6e22e">trunc</span>(<span style="color:#ae81ff">365</span><span style="color:#f92672">*</span>tf)) <span style="color:#f92672">&amp;</span> (dstart <span style="color:#f92672">&lt;=</span> (woy_test<span style="color:#ae81ff">-7</span>)));

</code></pre></div></div>
<p>The number and type of features which are present in the dataframe depend of the trading strategies which are considered. In our case we have some general fields like the date of the main trade (i.e. <em>dstart</em>) with its entry time (i.e. <em>hour</em>), its direction (i.e. <em>sign</em>) and the expected number of points to hit a profit or a <a href="https://www.investopedia.com/articles/fundamental-analysis/10/strategy-performance-reports.asp" target="_blank">stop loss</a>
 (i.e. <em>tp_pts</em> and <em>sl_pts</em>) which specifies all the required fields to execute a transaction. Then there are some fields about the result of the transaction, like the final pnl (i.e. <em>pnl_simu</em>) and how long the open position was kept before getting closed (i.e. <em>lifetime</em>).</p>
<p>All the other fields are additional information which are specific to the strategy which has generated the transaction. Actually most of them are the true features which we needs to exploit in order to forecast the pnl of the transaction. For example, <em>pnl_day</em> is the average pnl per day that the given strategy has generated in the past. While <em>pf</em> is the average <a href="https://www.investopedia.com/articles/fundamental-analysis/10/strategy-performance-reports.asp" target="_blank">profit factor</a>
 up today. The last three columns (i.e. <em>pnl_simu</em>, <em>mtm_dist_simu</em>, <em>lifetime</em>) are the output of the tansaction so they cannot be part of the feature set for training.</p>
<div class="text-code-r"> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">str</span>(data)
 <span style="color:#e6db74">&#39;data.frame&#39;</span><span style="color:#f92672">:</span>   <span style="color:#ae81ff">29860</span> obs. of  <span style="color:#ae81ff">27</span> variables<span style="color:#f92672">:</span>
 <span style="color:#f92672">$</span> dstart         <span style="color:#f92672">:</span> Date, format<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;2020-03-16&#34;</span> <span style="color:#e6db74">&#34;2020-03-16&#34;</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> dend           <span style="color:#f92672">:</span> Factor w<span style="color:#f92672">/</span> <span style="color:#ae81ff">328</span> levels <span style="color:#e6db74">&#34;2014-06-27&#34;</span>,<span style="color:#e6db74">&#34;2014-07-04&#34;</span>,..<span style="color:#f92672">:</span> <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">300</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> woy            <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">11</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> yb             <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> max_pwrong_max <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">0.1</span> <span style="color:#ae81ff">0.1</span> <span style="color:#ae81ff">0.1</span> <span style="color:#ae81ff">0.1</span> <span style="color:#ae81ff">0.1</span> <span style="color:#ae81ff">0.1</span> <span style="color:#ae81ff">0.1</span> <span style="color:#ae81ff">0.1</span> <span style="color:#ae81ff">0.1</span> <span style="color:#ae81ff">0.1</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> min_avg_pnl_day<span style="color:#f92672">:</span> int  <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> dow            <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> hour           <span style="color:#f92672">:</span> Factor w<span style="color:#f92672">/</span> <span style="color:#ae81ff">32</span> levels <span style="color:#e6db74">&#34;09:00:00&#34;</span>,<span style="color:#e6db74">&#34;09:15:00&#34;</span>,..<span style="color:#f92672">:</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">6</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> sign           <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">-1</span> <span style="color:#ae81ff">-1</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> tp_pts         <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">32</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> sl_pts         <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">23</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">23</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">23</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">23</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> pnl            <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">204</span> <span style="color:#ae81ff">77.6</span> <span style="color:#ae81ff">175</span> <span style="color:#ae81ff">204</span> <span style="color:#ae81ff">77.6</span> <span style="color:#ae81ff">175</span> <span style="color:#ae81ff">204</span> <span style="color:#ae81ff">77.6</span> <span style="color:#ae81ff">175</span> <span style="color:#ae81ff">204</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> pf             <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">9.79</span> <span style="color:#ae81ff">10.7</span> <span style="color:#ae81ff">5.99</span> <span style="color:#ae81ff">9.79</span> <span style="color:#ae81ff">10.7</span> <span style="color:#ae81ff">5.99</span> <span style="color:#ae81ff">9.79</span> <span style="color:#ae81ff">10.7</span> <span style="color:#ae81ff">5.99</span> <span style="color:#ae81ff">9.79</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> ctr_tp         <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">9</span> <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">9</span> <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">9</span> <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">9</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> ctr_sl         <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> ctr_tot        <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">9</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">9</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">9</span> <span style="color:#ae81ff">10</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> pnl_day        <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">20.4</span> <span style="color:#ae81ff">9.7</span> <span style="color:#ae81ff">19.4</span> <span style="color:#ae81ff">20.4</span> <span style="color:#ae81ff">9.7</span> <span style="color:#ae81ff">19.4</span> <span style="color:#ae81ff">20.4</span> <span style="color:#ae81ff">9.7</span> <span style="color:#ae81ff">19.4</span> <span style="color:#ae81ff">20.4</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> pwrong_max     <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">0.0839</span> <span style="color:#ae81ff">0.0403</span> <span style="color:#ae81ff">0.0814</span> <span style="color:#ae81ff">0.0839</span> <span style="color:#ae81ff">0.0403</span> <span style="color:#ae81ff">0.0814</span> <span style="color:#ae81ff">0.0839</span> <span style="color:#ae81ff">0.0403</span> <span style="color:#ae81ff">0.0814</span> <span style="color:#ae81ff">0.0839</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> pwrong_max_h   <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">0.905</span> <span style="color:#ae81ff">0.753</span> <span style="color:#ae81ff">0.898</span> <span style="color:#ae81ff">0.905</span> <span style="color:#ae81ff">0.753</span> <span style="color:#ae81ff">0.898</span> <span style="color:#ae81ff">0.905</span> <span style="color:#ae81ff">0.753</span> <span style="color:#ae81ff">0.898</span> <span style="color:#ae81ff">0.905</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> pwrong_max_n1  <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">1.9</span> <span style="color:#ae81ff">1.92</span> <span style="color:#ae81ff">1.91</span> <span style="color:#ae81ff">1.9</span> <span style="color:#ae81ff">1.92</span> <span style="color:#ae81ff">1.91</span> <span style="color:#ae81ff">1.9</span> <span style="color:#ae81ff">1.92</span> <span style="color:#ae81ff">1.91</span> <span style="color:#ae81ff">1.9</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> pwrong_max_n2  <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">1.64</span> <span style="color:#ae81ff">1.7</span> <span style="color:#ae81ff">1.67</span> <span style="color:#ae81ff">1.64</span> <span style="color:#ae81ff">1.7</span> <span style="color:#ae81ff">1.67</span> <span style="color:#ae81ff">1.64</span> <span style="color:#ae81ff">1.7</span> <span style="color:#ae81ff">1.67</span> <span style="color:#ae81ff">1.64</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> pwrong_max_n3  <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">0.899</span> <span style="color:#ae81ff">1.05</span> <span style="color:#ae81ff">0.974</span> <span style="color:#ae81ff">0.899</span> <span style="color:#ae81ff">1.05</span> <span style="color:#ae81ff">0.974</span> <span style="color:#ae81ff">0.899</span> <span style="color:#ae81ff">1.05</span> <span style="color:#ae81ff">0.974</span> <span style="color:#ae81ff">0.899</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> pwrong_max_n4  <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">0.331</span> <span style="color:#ae81ff">0.474</span> <span style="color:#ae81ff">0.396</span> <span style="color:#ae81ff">0.331</span> <span style="color:#ae81ff">0.474</span> <span style="color:#ae81ff">0.396</span> <span style="color:#ae81ff">0.331</span> <span style="color:#ae81ff">0.474</span> <span style="color:#ae81ff">0.396</span> <span style="color:#ae81ff">0.331</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> ccl_area       <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">12</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> pnl_simu       <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">-12.5</span> <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">-12.5</span> <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">-12.5</span> <span style="color:#ae81ff">32</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> mtm_dist_simu  <span style="color:#f92672">:</span> num  <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">17</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">17</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">17</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">18</span> <span style="color:#66d9ef">...</span>
 <span style="color:#f92672">$</span> lifetime       <span style="color:#f92672">:</span> int  <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">6</span> <span style="color:#66d9ef">...</span>

</code></pre></div></div>
<p>Since we are interested only to detect the gaining trades a bare classification is sufficient so we can add a class field to our dataframe and to reformat some of the fields in order to have a dataset which is consistent with the classification process.</p>
<div class="text-code-r"> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"> <span style="color:#75715e"># clean up</span>
 data <span style="color:#f92672">=</span> data[<span style="color:#f92672">-</span><span style="color:#a6e22e">which</span>(data<span style="color:#f92672">$</span>pnl_simu <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>),];

 <span style="color:#75715e"># remove na&#39;s if you have them</span>
 <span style="color:#a6e22e">if</span>(<span style="color:#a6e22e">anyNA</span>(data)) data <span style="color:#f92672">=</span> <span style="color:#a6e22e">na.omit</span>(data);
 
 <span style="color:#75715e"># add class</span>
 data<span style="color:#f92672">$</span>class <span style="color:#f92672">=</span> <span style="color:#a6e22e">sign</span>(data<span style="color:#f92672">$</span>pnl_simu);
 data<span style="color:#f92672">$</span>class <span style="color:#f92672">=</span> <span style="color:#a6e22e">factor</span>(data<span style="color:#f92672">$</span>class, labels<span style="color:#f92672">=</span><span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;N&#34;</span>, <span style="color:#e6db74">&#34;P&#34;</span>));

 <span style="color:#75715e"># reformat</span>
 data<span style="color:#f92672">$</span>hour <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.numeric</span>(data<span style="color:#f92672">$</span>hour);
 data<span style="color:#f92672">$</span>dstart <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.numeric</span>(data<span style="color:#f92672">$</span>dstart);

</code></pre></div></div>
<p>It is also interesting to check if some predictors used for forecasting are strongly correlated because, of course, they don&rsquo;t bring any additional information for learning and so they can be safely removed.  In particular, we can see that all the <em>pwrong_max_nx</em> variables and <em>ctr_tot</em> are strongly correlated so we removed them.</p>
<div class="text-code-r"> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"> <span style="color:#75715e"># correlation analysis</span>
 <span style="color:#a6e22e">library</span>(corrplot)

 cm <span style="color:#f92672">=</span> <span style="color:#a6e22e">cor</span>(data[, <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">24</span>]); <span style="color:#a6e22e">corrplot</span>(cm);
 cm <span style="color:#f92672">=</span> <span style="color:#a6e22e">cor</span>(data[, <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">17</span><span style="color:#f92672">:</span><span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">24</span>)]); <span style="color:#a6e22e">corrplot</span>(cm);

 feat <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">17</span><span style="color:#f92672">:</span><span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">24</span>);
 
</code></pre></div></div>
<div class="image-row"> 
  <div class="image-column">
    <img src="../img/blog-fpd/feat-corr1.png" style="width:90%">
  </div>
  <div class="image-column">  
    <img src="../img/blog-fpd/feat-corr2.png" style="width:90%">
  </div>
</div>
<p>We will start considering a random forest model. Data is partitioned in two sets, one for training and one for testing. Training is done by the caret package. Many options can be selected, we opted for repeated cross validation in order to have a robust fitting and ROC as key metric for the loss function.</p>
<div class="text-code-r"> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"> <span style="color:#75715e"># training RF model</span>
 <span style="color:#a6e22e">library</span>(caret)
 <span style="color:#a6e22e">library</span>(parallel)
 <span style="color:#a6e22e">library</span>(doParallel)

 <span style="color:#75715e"># enable parallel computing</span>
 myCluster <span style="color:#f92672">=</span> <span style="color:#a6e22e">makeCluster</span>(<span style="color:#a6e22e">detectCores</span>()<span style="color:#ae81ff">-1</span>);
 <span style="color:#a6e22e">registerDoParallel</span>(myCluster);

 <span style="color:#75715e"># features selection</span>
 fset <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;dstart&#34;</span>, <span style="color:#e6db74">&#34;dow&#34;</span>, <span style="color:#e6db74">&#34;hour&#34;</span>), <span style="color:#a6e22e">names</span>(data)[feat], <span style="color:#e6db74">&#34;class&#34;</span>);

 <span style="color:#75715e"># splitting training and testing dataset</span>
 <span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">567</span>);
 inTrain <span style="color:#f92672">=</span> <span style="color:#a6e22e">createDataPartition</span>(y <span style="color:#f92672">=</span> data<span style="color:#f92672">$</span>class, p <span style="color:#f92672">=</span> <span style="color:#ae81ff">.75</span>, list <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>);

 training <span style="color:#f92672">=</span> data[inTrain, fset];
 testing <span style="color:#f92672">=</span> data[<span style="color:#f92672">-</span>inTrain, fset];

 <span style="color:#75715e"># training </span>
 <span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">567</span>);
 ctrl <span style="color:#f92672">=</span> <span style="color:#a6e22e">trainControl</span>(method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;repeatedcv&#34;</span>, repeats <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, classProbs <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, summaryFunction <span style="color:#f92672">=</span> twoClassSummary);
 rfFit <span style="color:#f92672">=</span> caret<span style="color:#f92672">::</span><span style="color:#a6e22e">train</span>(class <span style="color:#f92672">~</span> ., data <span style="color:#f92672">=</span> training, method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rf&#34;</span>, preProc <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;center&#34;</span>, <span style="color:#e6db74">&#34;scale&#34;</span>),  tuneLength <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>, trControl <span style="color:#f92672">=</span> ctrl,  metric <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ROC&#34;</span>, allowParallel<span style="color:#f92672">=</span>T);

 <span style="color:#75715e"># training result</span>
 rfFit
 Random Forest 

 <span style="color:#ae81ff">48974</span> samples
    <span style="color:#ae81ff">10</span> predictors
     <span style="color:#ae81ff">2</span> classes<span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;N&#39;</span>, <span style="color:#e6db74">&#39;P&#39;</span> 

 Pre<span style="color:#f92672">-</span>processing<span style="color:#f92672">:</span> <span style="color:#a6e22e">centered </span>(<span style="color:#ae81ff">10</span>), <span style="color:#a6e22e">scaled </span>(<span style="color:#ae81ff">10</span>) 
 Resampling<span style="color:#f92672">:</span> Cross<span style="color:#f92672">-</span><span style="color:#a6e22e">Validated </span>(<span style="color:#ae81ff">10</span> fold, repeated <span style="color:#ae81ff">3</span> times) 
 Summary of sample sizes<span style="color:#f92672">:</span> <span style="color:#ae81ff">44077</span>, <span style="color:#ae81ff">44076</span>, <span style="color:#ae81ff">44076</span>, <span style="color:#ae81ff">44076</span>, <span style="color:#ae81ff">44076</span>, <span style="color:#ae81ff">44077</span>, <span style="color:#66d9ef">...</span> 
 Resampling results across tuning parameters<span style="color:#f92672">:</span>

   mtry  ROC        Sens       Spec     
    <span style="color:#ae81ff">2</span>    <span style="color:#ae81ff">0.9999080</span>  <span style="color:#ae81ff">0.9951705</span>  <span style="color:#ae81ff">0.9954507</span>
    <span style="color:#ae81ff">4</span>    <span style="color:#ae81ff">0.9999126</span>  <span style="color:#ae81ff">0.9953134</span>  <span style="color:#ae81ff">0.9955807</span>
    <span style="color:#ae81ff">6</span>    <span style="color:#ae81ff">0.9999115</span>  <span style="color:#ae81ff">0.9954277</span>  <span style="color:#ae81ff">0.9955677</span>
    <span style="color:#ae81ff">8</span>    <span style="color:#ae81ff">0.9999087</span>  <span style="color:#ae81ff">0.9955991</span>  <span style="color:#ae81ff">0.9956977</span>
   <span style="color:#ae81ff">10</span>    <span style="color:#ae81ff">0.9999016</span>  <span style="color:#ae81ff">0.9956848</span>  <span style="color:#ae81ff">0.9954767</span>

 ROC was used to select the optimal model using the largest value.
 The final value used for the model was mtry <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>.

</code></pre></div></div>
<p>Learning by cross-validation results on an astonishing ROC of 0.999 for mtry=4 and sens/spec of 0.995. We can test our model on an independent dataset in order to validate the out-of-sample ROC/sens/spec metrics.</p>
<div class="text-code-r"> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"> <span style="color:#75715e"># ROC graph</span>
 <span style="color:#a6e22e">library</span>(pROC)

 <span style="color:#75715e"># prediction</span>
 rfProbs <span style="color:#f92672">=</span> <span style="color:#a6e22e">predict</span>(rfFit, newdata <span style="color:#f92672">=</span> testing[, <span style="color:#f92672">-</span><span style="color:#a6e22e">ncol</span>(testing)], type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;prob&#34;</span>);
 rfClasses <span style="color:#f92672">=</span> <span style="color:#a6e22e">predict</span>(rfFit, newdata <span style="color:#f92672">=</span> testing[, <span style="color:#f92672">-</span><span style="color:#a6e22e">ncol</span>(testing)]);

 <span style="color:#75715e"># testing CM and ROC</span>
 CM <span style="color:#f92672">=</span> caret<span style="color:#f92672">::</span><span style="color:#a6e22e">confusionMatrix</span>(rfClasses, testing<span style="color:#f92672">$</span>class, positive<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;P&#34;</span>);

 ROC <span style="color:#f92672">=</span> <span style="color:#a6e22e">roc</span>(response <span style="color:#f92672">=</span> testing<span style="color:#f92672">$</span>class, predictor <span style="color:#f92672">=</span> rfProbs[,<span style="color:#ae81ff">2</span>], levels <span style="color:#f92672">=</span> <span style="color:#a6e22e">rev</span>(<span style="color:#a6e22e">levels</span>(testing<span style="color:#f92672">$</span>class)));
 <span style="color:#a6e22e">plot</span>(ROC, lwd<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, col<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;red&#34;</span>); <span style="color:#a6e22e">auc</span>(ROC);

</code></pre></div></div>
<p>The results of testing are extremely similar to the metrics of the training, so confronting us on the good quality of model. Even the ROC plot looks so good that it is almost incredible. Unfortunately, as it is often in life, such result is too good to be true ! It will be sufficient to apply our model to the predictions of the actual days in order to discover that accuracy, sensitivity and any other possible metric are in fact much worse than the predicted ones. We are in a typical case of overfitting!</p>
<div class="image-row"> 
  <div class="image-column">
    <div class="text-code-r" style="width:80% "> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"> <span style="color:#75715e"># testing results: CM</span>
 Confusion Matrix and Statistics

           Reference
 Prediction    N    P
          N <span style="color:#ae81ff">3405</span>   <span style="color:#ae81ff">13</span>
          P   <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">3214</span>
                                           
                Accuracy <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.9967</span>          
                  <span style="color:#ae81ff">95</span>% CI <span style="color:#f92672">:</span> (<span style="color:#ae81ff">0.9957</span>, <span style="color:#ae81ff">0.9975</span>)
     No Information Rate <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.5228</span>          
     P<span style="color:#f92672">-</span>Value [Acc <span style="color:#f92672">&gt;</span> NIR] <span style="color:#f92672">:</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2e-16</span>         
                                           
                   Kappa <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.9934</span>          
                                           
  Mcnemar<span style="color:#e6db74">&#39;s Test P-Value : 0.07688         
</span><span style="color:#e6db74">                                           
</span><span style="color:#e6db74">             Sensitivity : 0.9977          
</span><span style="color:#e6db74">             Specificity : 0.9956          
</span><span style="color:#e6db74">          Pos Pred Value : 0.9960          
</span><span style="color:#e6db74">          Neg Pred Value : 0.9974          
</span><span style="color:#e6db74">              Prevalence : 0.5228          
</span><span style="color:#e6db74">          Detection Rate : 0.5216          
</span><span style="color:#e6db74">    Detection Prevalence : 0.5236          
</span><span style="color:#e6db74">       Balanced Accuracy : 0.9966          
</span><span style="color:#e6db74">                                           
</span><span style="color:#e6db74">        &#39;</span>Positive<span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010"> Class : P               </span>

</code></pre></div></div>
  </div>
  <div class="image-column">  
    <img src="../img/blog-fpd/testing-roc.jpg" style="width:110% centering">
  </div>
</div>
<p>The <em>verif</em> dataset consists of the trades of five days of the actual week. It is cleaned it up and formatted, like we already did for training/testing datasets, and duplicated trades with same day/hour are removed. Then <em>rfFit</em> model is applied for forecasting, CM and ROC are computed.</p>
<div class="text-code-r"> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"> <span style="color:#75715e"># create a dataset for verification</span>
 verif <span style="color:#f92672">=</span> <span style="color:#a6e22e">subset</span>(dd, (dstart <span style="color:#f92672">&gt;=</span> woy_test<span style="color:#ae81ff">-4</span>) <span style="color:#f92672">&amp;</span> (dstart <span style="color:#f92672">&lt;=</span> woy_test));

 verif <span style="color:#f92672">=</span> verif[<span style="color:#f92672">-</span><span style="color:#a6e22e">which</span>(verif<span style="color:#f92672">$</span>pnl_simu <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>),];
 <span style="color:#a6e22e">if</span>(<span style="color:#a6e22e">anyNA</span>(verif)) verif <span style="color:#f92672">=</span> <span style="color:#a6e22e">na.omit</span>(verif);

 verif<span style="color:#f92672">$</span>class <span style="color:#f92672">=</span> <span style="color:#a6e22e">sign</span>(verif<span style="color:#f92672">$</span>pnl_simu);
 verif<span style="color:#f92672">$</span>class <span style="color:#f92672">=</span> <span style="color:#a6e22e">factor</span>(verif<span style="color:#f92672">$</span>class, labels<span style="color:#f92672">=</span><span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;N&#34;</span>, <span style="color:#e6db74">&#34;P&#34;</span>));

 verif<span style="color:#f92672">$</span>hour <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.numeric</span>(verif<span style="color:#f92672">$</span>hour);
 verif<span style="color:#f92672">$</span>dstart <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.numeric</span>(verif<span style="color:#f92672">$</span>dstart);

 verif_split<span style="color:#f92672">=</span><span style="color:#a6e22e">group_split</span>(verif <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">group_by</span>(dstart, dow, hour));
 verif_unique <span style="color:#f92672">=</span> <span style="color:#a6e22e">ldply</span>(<span style="color:#a6e22e">lapply</span>(verif_split, <span style="color:#a6e22e">function</span>(x) <span style="color:#a6e22e">as.data.frame</span>(x)[1,]), rbind);

 verif_pnl_simu <span style="color:#f92672">=</span> <span style="color:#a6e22e">data.frame</span>(pnl_simu<span style="color:#f92672">=</span>verif_unique<span style="color:#f92672">$</span>pnl_simu); <span style="color:#a6e22e">rownames</span>(verif_pnl_simu) <span style="color:#f92672">=</span> <span style="color:#a6e22e">rownames</span>(verif_unique);
 verif <span style="color:#f92672">=</span> verif_unique[, fset];

 <span style="color:#75715e"># forecasting, CM and ROC</span>
 rfProbs <span style="color:#f92672">=</span> <span style="color:#a6e22e">predict</span>(rfFit, newdata <span style="color:#f92672">=</span> verif[, <span style="color:#f92672">-</span><span style="color:#a6e22e">ncol</span>(verif)], type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;prob&#34;</span>);
 rfClasses <span style="color:#f92672">=</span> <span style="color:#a6e22e">predict</span>(rfFit, newdata <span style="color:#f92672">=</span> verif[, <span style="color:#f92672">-</span><span style="color:#a6e22e">ncol</span>(verif)]);

 CM <span style="color:#f92672">=</span> caret<span style="color:#f92672">::</span><span style="color:#a6e22e">confusionMatrix</span>(rfClasses, verif<span style="color:#f92672">$</span>class, positive<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;P&#34;</span>);

 ROC <span style="color:#f92672">=</span> <span style="color:#a6e22e">roc</span>(response <span style="color:#f92672">=</span> verif<span style="color:#f92672">$</span>class, predictor <span style="color:#f92672">=</span> rfProbs[,<span style="color:#ae81ff">2</span>], levels <span style="color:#f92672">=</span> <span style="color:#a6e22e">rev</span>(<span style="color:#a6e22e">levels</span>(verif<span style="color:#f92672">$</span>class)));
 <span style="color:#a6e22e">plot</span>(ROC, lwd<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, col<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;red&#34;</span>, main<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ROC Plot (verif dataset)&#34;</span>); <span style="color:#a6e22e">grid</span>(); <span style="color:#a6e22e">auc</span>(ROC);

</code></pre></div></div>
<br>
<div class="image-row"> 
  <div class="image-column">
    <div class="text-code-r" style="width:80% "> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#75715e"># verif results: CM</span>
Confusion Matrix and Statistics

          Reference
Prediction N P
         N <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">7</span>
         P <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">7</span>
                                          
               Accuracy <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.5385</span>          
                 <span style="color:#ae81ff">95</span>% CI <span style="color:#f92672">:</span> (<span style="color:#ae81ff">0.3337</span>, <span style="color:#ae81ff">0.7341</span>)
    No Information Rate <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.5385</span>          
    P<span style="color:#f92672">-</span>Value [Acc <span style="color:#f92672">&gt;</span> NIR] <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.5796</span>          
                                          
                  Kappa <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.0824</span>          
                                          
 Mcnemar<span style="color:#e6db74">&#39;s Test P-Value : 0.7728          
</span><span style="color:#e6db74">                                          
</span><span style="color:#e6db74">            Sensitivity : 0.5000          
</span><span style="color:#e6db74">            Specificity : 0.5833          
</span><span style="color:#e6db74">         Pos Pred Value : 0.5833          
</span><span style="color:#e6db74">         Neg Pred Value : 0.5000          
</span><span style="color:#e6db74">             Prevalence : 0.5385          
</span><span style="color:#e6db74">         Detection Rate : 0.2692          
</span><span style="color:#e6db74">   Detection Prevalence : 0.4615          
</span><span style="color:#e6db74">      Balanced Accuracy : 0.5417          
</span><span style="color:#e6db74">                                          
</span><span style="color:#e6db74">       &#39;</span>Positive<span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010"> Class : P                     </span>

<span style="color:#a6e22e">auc</span>(ROC);
Area under the curve<span style="color:#f92672">:</span> <span style="color:#ae81ff">0.6815</span>
</code></pre></div></div>
  </div>
  <div class="image-column">  
    <img src="../img/blog-fpd/verif-roc.jpeg" style="width:110% centering">
  </div>
</div>
<p>Unfortunately the predictions of the rfFit model to the verif dataset are not very good, the ROC plot has an AUC of 0.68 which basically means that the model has limited capacity to distinguish between positive class and negative class. In fact, it is only marginally better than a random discriminator. Therefore it is not possible to predict in a safe way whether a new transaction is going to produce a profit or a loss.</p>
<p>Still, it is possible to gain some marginal improvement of such classification by changing the probability threshold used to discriminate between P and N classes. Instead of adopting the default value of 0.5, we can look for the optimal value which will result on an higher accuracy and sensitivity/specificity. Such optimal value can be computed by detecting on the ROC plot the nearest point to the corner (1.0, 1.0).</p>
<div class="text-code-r"> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"> <span style="color:#75715e"># computing optimal threshold on verif</span>
 dist <span style="color:#f92672">=</span> (ROC<span style="color:#f92672">$</span>sensitivities<span style="color:#ae81ff">-1</span>)^2<span style="color:#f92672">+</span>(ROC<span style="color:#f92672">$</span>specificities<span style="color:#ae81ff">-1</span>)^2;

 id <span style="color:#f92672">=</span> <span style="color:#a6e22e">which.min</span>(dist); opt_threshold <span style="color:#f92672">=</span> ROC<span style="color:#f92672">$</span>threshold[id];
 <span style="color:#a6e22e">plot</span>(dist, main<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Distance to (1.0, 1.0)&#34;</span>); <span style="color:#a6e22e">grid</span>(); <span style="color:#a6e22e">points</span>(id, dist[id], col<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;green&#34;</span>, pch<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>);

 CM <span style="color:#f92672">=</span> caret<span style="color:#f92672">::</span><span style="color:#a6e22e">confusionMatrix</span>(<span style="color:#a6e22e">table</span>(rfProbs[, <span style="color:#e6db74">&#34;P&#34;</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.354</span>, verif<span style="color:#f92672">$</span>class <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;P&#34;</span>), positive<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;TRUE&#34;</span>)

</code></pre></div></div>
<p>By computing the point at minimal distance, green point in the following figure, we get an optimal threshold of 0.354. The new CM is the following one where we can see the performance metrics are quite improved.</p>
<div class="image-row"> 
  <div class="image-column">
    <div class="text-code-r" style="width:80% "> 
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#75715e"># verif results: CM</span>
Confusion Matrix and Statistics

       
        <span style="color:#66d9ef">FALSE</span> <span style="color:#66d9ef">TRUE</span>
  <span style="color:#66d9ef">FALSE</span>     <span style="color:#ae81ff">7</span>    <span style="color:#ae81ff">3</span>
  <span style="color:#66d9ef">TRUE</span>      <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">11</span>
                                          
               Accuracy <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.6923</span>          
                 <span style="color:#ae81ff">95</span>% CI <span style="color:#f92672">:</span> (<span style="color:#ae81ff">0.4821</span>, <span style="color:#ae81ff">0.8567</span>)
    No Information Rate <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.5385</span>          
    P<span style="color:#f92672">-</span>Value [Acc <span style="color:#f92672">&gt;</span> NIR] <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.08294</span>         
                                          
                  Kappa <span style="color:#f92672">:</span> <span style="color:#ae81ff">0.3735</span>          
                                          
 Mcnemar<span style="color:#e6db74">&#39;s Test P-Value : 0.72367         
</span><span style="color:#e6db74">                                          
</span><span style="color:#e6db74">            Sensitivity : 0.7857          
</span><span style="color:#e6db74">            Specificity : 0.5833          
</span><span style="color:#e6db74">         Pos Pred Value : 0.6875          
</span><span style="color:#e6db74">         Neg Pred Value : 0.7000          
</span><span style="color:#e6db74">             Prevalence : 0.5385          
</span><span style="color:#e6db74">         Detection Rate : 0.4231          
</span><span style="color:#e6db74">   Detection Prevalence : 0.6154          
</span><span style="color:#e6db74">      Balanced Accuracy : 0.6845          
</span><span style="color:#e6db74">                                          
</span><span style="color:#e6db74">       &#39;</span>Positive<span style="color:#e6db74">&#39;</span><span style="color:#960050;background-color:#1e0010"> Class : TRUE          </span>

<span style="color:#a6e22e">auc</span>(ROC);
Area under the curve<span style="color:#f92672">:</span> <span style="color:#ae81ff">0.5609</span>
</code></pre></div></div>
  </div>
  <div class="image-column">  
    <img src="../img/blog-fpd/opt-dist.jpg" style="width:110% centering">
  </div>
</div>
<p>It is interesting to compare the expected pnl from adopting the two possible thresholds of 0.5 and 0.354. As we expected the differences are important because higher values of sensitivity/specificity resulted on an overall positive pnl for the week when the default threshold wouldn&rsquo;t have produced any.</p>
 <div class="">  
    <img src="../img/blog-fpd/weekly-pnl2.jpg" style="width:100% centering">
 </div>
<p>Now, the good choice of the threshold seems to be essential to select a winning strategy. Unfortunately, the approach we adopted to compute the optimal threshold cannot be applied in the practice because we exploited the posterior knowledge of trade results in our computation.  However, the intuition that the choice of a good threshold can be sufficient to provide a positive pnl even when the forecasting model has somehow limited forecasting capabilities like in our case, it is an interesting fact.</p>
</div>

      </section>

      <footer class="post-card-meta">
          <img class="author-profile-image" src="https://techvagabond.org/img/profile-picture-gl.jpg" alt="Author" />
          <span class="post-card-author"><a href="/">Gabriele Luculli</a></span>
      </footer>
    </div>
</article>
    </div>

    <nav class="pagination" role="navigation">
      
          <a class="newer-posts" href="/flac-decoder-benchmarking-on-arm/">&larr; <span class="hide">Next Post</span></a>
      
      <span class="page-number">&nbsp;</span>
      
    </nav>

    
    
    

  </div>
</main>



<footer class="site-footer outer">
  <div class="site-footer-content inner">
    <section class="copyright" style="line-height: 1.3em;">
      <a href="/"></a> v0.4.0 - Nov/2020 - GL 2020 - root@techvagabond.org <br>
      
    </section>
    <nav class="site-footer-nav">
        <a href="/">Latest Posts</a>
        
        
        <a href="https://github.com/luculli" target="_blank" rel="noopener">Github</a>
        
        
    </nav>  
  </div>
</footer>

</div>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="https://techvagabond.org/js/jquery.fitvids.js"></script>

<script>hljs.initHighlightingOnLoad();</script>




</body></html>
